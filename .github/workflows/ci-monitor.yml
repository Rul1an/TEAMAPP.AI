name: "ðŸ”Ž CI Monitor"

on:
  # Trigger after any job (build / test / deploy) completes in this repository.
  check_suite:
    types: [completed]
  # Fallback daily run to catch very old failed runs (optional)
  schedule:
    - cron: '0 3 * * *'

jobs:
  monitor:
    if: ${{ github.event_name == 'check_suite' && github.event.check_suite.conclusion != 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“£ Open or comment on CI failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.check_suite;
            const issueTitle = `CI failure: ${run.head_branch || 'unknown-branch'} â€“ Suite #${run.id}`;
            // Search for an existing open issue with this exact title.
            const search = await github.rest.search.issuesAndPullRequests({
              q: `repo:${context.repo.owner}/${context.repo.repo} is:issue in:title "${issueTitle}" state:open`
            });
            if (search.data.total_count === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: `The check suite for branch **${run.head_branch || 'unknown'}** ([details](${run.html_url})) finished with conclusion **${run.conclusion}**.\n\nPlease investigate the logs and fix failing steps.`,
                labels: ['ci']
              });
              console.log(`Opened new issue for failed run ${run.id}`);
            } else {
              const issueNumber = search.data.items[0].number;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `Another failure detected for suite [#${run.id}](${run.html_url}) â€“ conclusion: **${run.conclusion}**.`
              });
              console.log(`Appended comment to existing issue #${issueNumber}`);
            }