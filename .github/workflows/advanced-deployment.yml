name: ğŸš€ Advanced Flutter SaaS Deployment

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  release:
    types: [published]

env:
  FLUTTER_VERSION: '3.32.2'
  NODE_VERSION: '18'

jobs:
  # Quality Assurance
  quality-check:
    name: ğŸ” Quality Assurance
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ğŸ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ğŸ“¦ Install Dependencies
        working-directory: .
        run: flutter pub get

      - name: ğŸ” Static Analysis
        working-directory: .
        run: |
          flutter analyze --no-fatal-infos
          echo "âœ… Static analysis passed"

      - name: ğŸ¨ Format Check
        working-directory: .
        run: |
          dart format --set-exit-if-changed .
          echo "âœ… Code formatting is correct"

      - name: ğŸ§ª Unit Tests
        working-directory: .
        run: |
          flutter test --coverage
          echo "âœ… Unit tests passed"

      - name: ğŸ“Š Upload Coverage
        if: ${{ hashFiles('coverage/lcov.info') != '' }}
        uses: codecov/codecov-action@v3
        with:
          files: coverage/lcov.info
          fail_ci_if_error: false

  # Security Scan
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ğŸ” Dependency Security Scan
        working-directory: .
        run: |
          flutter pub deps
          echo "âœ… Dependency security scan completed"

      - name: ğŸ¯ SAST Scan
        uses: github/super-linter@v4
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_DART: true
          VALIDATE_YAML: true
          VALIDATE_JSON: true
          FILTER_REGEX_INCLUDE: '^(lib|supabase|test)/.*'
          FILTER_REGEX_EXCLUDE: '(\.tar\.gz$|coverage/)'

  # Build and Test
  build-and-test:
    name: ğŸ—ï¸ Build & Test
    needs: [quality-check, security-scan]
    strategy:
      matrix:
        platform: [web]
        include:
          - platform: web
            os: ubuntu-latest
    runs-on: ${{ matrix.os }}

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ğŸ“¦ Install Dependencies
        working-directory: .
        run: flutter pub get

      - name: ğŸ—ï¸ Build ${{ matrix.platform }}
        run: |
          case "${{ matrix.platform }}" in
            web)
              flutter build web --release --dart-define=ENVIRONMENT=production
              echo "âœ… Web build completed"
              ;;
          esac

      - name: âœ… Ensure Web Build Exists Before Upload
        run: |
          if [ ! -f build/web/index.html ]; then
            echo "âŒ build/web/index.html not found. Web build might have failed."
            exit 1
          fi
          ls -l build/web

      - name: ğŸ“¤ Upload Web Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-web
          path: build/web
          retention-days: 30

  # Performance Testing
  performance-test:
    name: âš¡ Performance Testing
    needs: [build-and-test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Web Build
        uses: actions/download-artifact@v4
        with:
          name: build-web
          path: build/web

      - name: ğŸ” Ensure Web Build Directory
        run: |
          if [ ! -f build/web/index.html ]; then
            echo "âŒ build/web/index.html missing after download."
            exit 1
          fi

      - name: ğŸ¯ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install Lighthouse
        run: npm install -g lighthouse

      - name: ğŸ› Debug Web Build Output
        run: head -20 build/web/index.html

      - name: ğŸŒ Start Local Server
        run: |
          npx serve -s build/web -l 8080 &
          sleep 20

      - name: ğŸŒ Verify index.html Served
        run: |
          HTTP_CODE=$(curl -Ls -o /dev/null -w "%{http_code}" http://localhost:8080/index.html || true)
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ index.html not served correctly (HTTP $HTTP_CODE)"
            exit 1
          fi
          echo "âœ… index.html served correctly"

      - name: ğŸš€ Run Lighthouse Audit (A11y / BP / SEO)
        run: |
          lighthouse http://localhost:8080 \
            --output json \
            --output-path lighthouse-report.json \
            --chrome-flags="--headless --no-sandbox" \
            --only-categories=accessibility,best-practices,seo

      - name: ğŸ“Š Parse Lighthouse Results (A11y / BP / SEO)
        run: |
          A11Y_RAW=$(jq '.categories.accessibility.score' lighthouse-report.json)
          BP_RAW=$(jq '.categories["best-practices"].score' lighthouse-report.json)
          SEO_RAW=$(jq '.categories.seo.score' lighthouse-report.json)

          A11Y_SCORE=$(echo "$A11Y_RAW * 100" | bc -l)
          BP_SCORE=$(echo "$BP_RAW * 100" | bc -l)
          SEO_SCORE=$(echo "$SEO_RAW * 100" | bc -l)

          echo "Accessibility Score: $A11Y_SCORE"
          echo "Best-Practices Score: $BP_SCORE"
          echo "SEO Score: $SEO_SCORE"

          MIN_THRESHOLD=80
          FAIL=0
          for SCORE in $A11Y_SCORE $BP_SCORE $SEO_SCORE; do
            IS_BELOW=$(echo "$SCORE < $MIN_THRESHOLD" | bc -l)
            if [ $IS_BELOW -eq 1 ]; then
              FAIL=1
            fi
          done

          if [ $FAIL -eq 1 ]; then
            echo "âŒ One or more Lighthouse scores below $MIN_THRESHOLD"
            exit 1
          else
            echo "âœ… All Lighthouse scores meet threshold ($MIN_THRESHOLD+)"
          fi

  # Deploy to Staging
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    needs: [build-and-test, performance-test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment: staging

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Web Build
        uses: actions/download-artifact@v4
        with:
          name: build-web
          path: build/web

      - name: ğŸš€ Deploy to Netlify Staging
        uses: netlify/actions/cli@master
        with:
          args: deploy --dir=build/web --alias=staging
        env:
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_STAGING_SITE_ID }}
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}

      - name: ğŸ’¬ Comment PR with Staging URL
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸš€ Staging deployment ready! Preview: https://staging--teamappai.netlify.app'
            })

  # Deploy to Production
  deploy-production:
    name: ğŸŒŸ Deploy to Production
    needs: [build-and-test, performance-test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Web Build
        uses: actions/download-artifact@v4
        with:
          name: build-web
          path: build/web

      - name: ğŸŒŸ Deploy to Netlify Production
        uses: netlify/actions/cli@master
        with:
          args: deploy --dir=build/web --prod
        env:
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}

      - name: ğŸ“Š Send Deployment Metrics
        run: |
          # Send metrics to monitoring service
          curl -X POST "https://api.sentry.io/api/0/organizations/${{ secrets.SENTRY_ORG }}/releases/" \
            -H "Authorization: Bearer ${{ secrets.SENTRY_AUTH_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "version": "${{ github.sha }}",
              "projects": ["jo17-tactical-manager"],
              "dateCreated": "'$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)'"
            }'

      - name: ğŸ‰ Notify Success (Slack)
        if: ${{ success() && env.SLACK_WEBHOOK_URL != '' }}
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: "ğŸ‰ Production deployment successful! Live at: https://teamappai.netlify.app"

  # Post-deployment Health Check
  health-check:
    name: ğŸ¥ Health Check
    needs: [deploy-production]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ¥ Production Health Check
        run: |
          echo "Running health checks..."

          # Check if site is accessible
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://teamappai.netlify.app)
          if [ $HTTP_STATUS -eq 200 ]; then
            echo "âœ… Site is accessible"
          else
            echo "âŒ Site health check failed (HTTP $HTTP_STATUS)"
            exit 1
          fi

          # Check critical endpoints
          curl -f https://teamappai.netlify.app/manifest.json || exit 1
          echo "âœ… Manifest accessible"

          # Performance check
          LOAD_TIME=$(curl -s -w "%{time_total}" -o /dev/null https://teamappai.netlify.app)
          echo "Load time: ${LOAD_TIME}s"

          if (( $(echo "$LOAD_TIME > 3.0" | bc -l) )); then
            echo "âš ï¸ Load time exceeds 3 seconds"
          else
            echo "âœ… Load time within acceptable range"
          fi

      - name: ğŸ“Š Update Status Badge
        run: |
          echo "âœ… All health checks passed - System operational"

  # Cleanup
  cleanup:
    name: ğŸ§¹ Cleanup
    needs: [health-check]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ğŸ§¹ Clean up artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const { data: artifacts } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });

            // Keep artifacts for 7 days, then clean up
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - 7);

            for (const artifact of artifacts.artifacts) {
              const createdAt = new Date(artifact.created_at);
              if (createdAt < cutoffDate) {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id,
                });
                console.log(`Deleted old artifact: ${artifact.name}`);
              }
            }
